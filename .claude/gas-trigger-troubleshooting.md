# Google Apps Script トリガー問題の修正記録

**日付**: 2025-08-04  
**対象システム**: 出席管理システム v3.2  
**問題対象**: Google Apps Script の出席通知メール機能  

## 問題の概要

出席管理アプリが Google Sheets にデータを記録する際、保護者への通知メールが正常に送信されない問題が発生していました。

### 発生していた問題
1. **onChangeトリガーの誤動作**: 編集(EDIT)タイプの変更で「新規行追加以外のため処理終了」となり通知がスキップ
2. **行特定の誤り**: 65行目の退出処理時に66行目のデータを参照してしまう
3. **onEditトリガーの未発火**: アプリケーションによる自動更新のためonEditトリガーが動作しない

## 問題分析と解決までの流れ

### Step 1: 初期問題の特定
**症状**: 
```
Cloud のログ
変更タイプ: EDIT
新規行追加以外のため処理終了
```

**原因**: onChangeトリガーが `INSERT_ROW` のみを処理対象としていた

**初期修正**: EDITタイプも処理対象に追加
```javascript
// 修正前
if (e.changeType !== 'INSERT_ROW') {
  return;
}

// 修正後  
if (e.changeType !== 'INSERT_ROW' && e.changeType !== 'EDIT') {
  return;
}
```

### Step 2: 行特定問題の発見
**症状**: 65行目の退出処理が66行目の入室処理として誤認される

**原因**: onChangeトリガーが常に `getLastRow()` を参照するため、編集された実際の行ではなく最終行を処理していた

### Step 3: onEditトリガーの問題
**症状**: onEditトリガーが全く発火しない（ログにonEditの記録がない）

**原因**: 
- 手動編集ではなく、**アプリケーションによる自動更新**のためonEditトリガーは発火しない
- Google Apps Scriptにおいて、プログラムによるセルの変更はonEditトリガーを発火させない仕様

## 最終解決策: onChange一本化 + タイムスタンプベース判定

### 修正方針
1. **onEditトリガーを削除**し、onChange一本で処理
2. **タイムスタンプベースの判定ロジック**を実装
3. **日付ベースの退出処理**で時系列問題を解決

### 実装された新ロジック

```javascript
function findLatestTimestampRowAndColumn(sheet) {
  // 入室処理：最新行のA列をチェック
  var lastRowIndex = data.length - 1;
  var lastEntryTime = toDate(lastRow[0]); // A列
  
  // 退出処理：当日全体のG列から最新タイムスタンプを検索
  for (var i = data.length - 1; i >= 1; i--) {
    var exitTime = toDate(row[6]); // G列
    if (exitTime && ymd(exitTime) === todayStr) {
      // 当日の退出時刻のみを対象にして最新を特定
    }
  }
}
```

### 新しい動作フロー

| アクション | トリガー | 判定ロジック | 結果 |
|------------|----------|--------------|------|
| アプリが入室記録追加 | onChange | 最新行A列タイムスタンプ | 入室通知 |
| アプリが退出時刻更新 | onChange | 当日全体G列最新タイムスタンプ | 退出通知 |

## 解決されたポイント

### 1. 時系列の逆転問題を解決
- **問題**: 後から来て先に帰った生徒のデータで処理が混乱
- **解決**: 退出処理では当日全体のG列から真の最新タイムスタンプを特定

### 2. 正確な行特定
- **問題**: 編集行と処理行の不整合
- **解決**: タイムスタンプベースで実際に変更された行を特定

### 3. トリガーの簡素化
- **問題**: onChange/onEditの競合と複雑性
- **解決**: onChange一本化でシンプルかつ確実な動作

## 運用上の注意点

1. **onEditトリガーは削除**: Google Apps ScriptエディタからonEditトリガーを削除する
2. **日付ベース処理**: 退出通知は当日分のみを対象とする設計
3. **マジックナンバー回避**: 行番号の直接指定は使用せず、動的に検索する

## テスト結果

修正後のテストで以下が確認できました：
- ✅ 65行目の退出処理が正常に動作
- ✅ 66行目のデータに影響されない
- ✅ 通知希望者への退出メール送信成功

## 今後の保守について

この修正により、出席管理システムの通知機能は安定して動作します。今後類似の問題が発生した場合は、以下を確認してください：

1. Google Apps Script の実行ログでトリガーの発火状況を確認
2. タイムスタンプの形式や日付判定ロジックの動作確認
3. データの蓄積に伴う処理性能の監視

---

**修正者**: Claude Code Assistant  
**確認日**: 2025-08-04  
**ステータス**: 解決済み