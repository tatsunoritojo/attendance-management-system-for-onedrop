# 出席管理システム v3.2 引継ぎ資料

## 📋 プロジェクト概要

### 基本情報
- **システム名**: 出席管理システム
- **現在バージョン**: v3.2.0
- **開発期間**: 2025年7月17日〜18日
- **開発言語**: Python 3.13.3
- **主要フレームワーク**: Kivy 2.3.1, Flask 3.1.1

### プロジェクト構成
```
attendance-management-system.3.2/
├── src/attendance_app/                 # メインアプリケーション
│   ├── main.py                        # エントリーポイント
│   ├── report_system/                 # レポート生成システム
│   │   ├── excel_report_generator.py  # Excel生成エンジン（v3.2新機能）
│   │   ├── report_generator.py        # PDF生成エンジン
│   │   └── data_analyzer.py           # データ分析
│   ├── assets/                        # アセットファイル
│   │   ├── reports_template.xlsx      # Excelテンプレート（v3.2）
│   │   └── images/                    # 画像ファイル
│   └── templates/                     # HTMLテンプレート
├── web_app/                           # Flask Webアプリケーション
│   ├── app.py                         # Flask アプリケーション
│   ├── templates/                     # HTMLテンプレート
│   └── static/                        # CSS・JavaScript
├── dist/AttendanceManagementSystem/   # 配布用実行ファイル
└── 配布用README.md                    # ユーザー向け説明書
```

## 🚀 v3.2 新機能詳細

### 1. Excel レポート生成機能

**ファイル**: `src/attendance_app/report_system/excel_report_generator.py`

#### 主要クラス
- `ExcelReportGenerator`: メイン生成クラス
- 主要メソッド:
  - `generate_monthly_reports()`: 全生徒レポート生成
  - `generate_single_student_report()`: 個別生徒レポート
  - `create_student_sheet()`: 生徒別シート作成
  - `add_dropdown_validation()`: プルダウンリスト追加

#### 技術実装
- **ライブラリ**: openpyxl 3.1.5
- **テンプレート**: `reports_template.xlsx`を参照
- **画像処理**: 透明背景ロゴの自動配置
- **データ検証**: プランニング・カウンセリング・個別対応列

#### 生成される内容
- A4横向きレイアウト
- 個別生徒シート（1ファイル内）
- プルダウンリスト（「　」「〇」選択）
- 印刷最適化（左余白2cm）

### 2. デスクトップ-Web連携機能

**ファイル**: `src/attendance_app/report_screen.py`

#### 実装内容
```python
def open_report_editor(self, instance):
    """レポートエディタをブラウザで開く"""
    try:
        editor_url = "http://localhost:5000"
        webbrowser.open(editor_url)
    except Exception as e:
        self.show_popup("エラー", f"ブラウザでレポートエディタを開けませんでした: {e}")
```

#### 連携フロー
1. デスクトップアプリの「レポートエディタ」ボタンクリック
2. `webbrowser.open()`でブラウザ起動
3. Flask Webアプリ（localhost:5000）に接続
4. リアルタイムレポート編集

### 3. 実行可能ファイル化

**設定ファイル**: `attendance_app.spec`

#### PyInstaller設定
- **エントリーポイント**: `src/attendance_app/main.py`
- **インクルードファイル**: 
  - フォント、画像、テンプレート
  - Webアプリケーション（templates, static）
  - 設定ファイル類

#### 相対インポート対応
```python
try:
    from .config import load_settings, save_settings
    # 他の相対インポート
except ImportError:
    # PyInstallerで実行される場合は絶対インポート
    from config import load_settings, save_settings
```

## 🔧 技術仕様

### 依存関係
```
kivy==2.3.1           # デスクトップアプリフレームワーク
flask==3.1.1          # Webアプリフレームワーク
openpyxl==3.1.5       # Excel操作（v3.2で追加）
reportlab==4.0.4      # PDF生成
Pillow==10.0.0        # 画像処理
google-api-python-client # Google API連携
gspread               # Google Sheets操作
pyinstaller==6.14.2   # 実行ファイル作成
```

### データベース設計
- **Google Sheets**: メインデータストレージ
- **CSV**: ローカルキャッシュ（`sample_data.csv`）
- **JSON**: 設定ファイル（`settings.json`）

### API設計
```
# Flask Web API
GET  /                          # トップページ
GET  /editor                    # レポートエディタ
POST /api/generate-excel-report # Excel生成API（v3.2追加）
POST /api/generate-report       # PDF生成API
POST /api/template              # テンプレート保存
```

## 🏗️ システム アーキテクチャ

### レイヤー構成
1. **プレゼンテーション層**
   - Kivy GUI（デスクトップ）
   - Flask Web UI（ブラウザ）

2. **ビジネスロジック層**
   - レポート生成エンジン
   - データ分析機能
   - 印刷制御

3. **データアクセス層**
   - Google Sheets API
   - Google Drive API
   - ローカルファイル操作

### 設計パターン
- **MVC**: Kivyアプリケーション
- **REST API**: Flask Webアプリケーション  
- **Template Method**: レポート生成
- **Factory**: 画像処理

## 🔄 開発ワークフロー

### 1. 開発環境セットアップ
```bash
# 1. リポジトリクローン
git clone [repository-url]
cd attendance-management-system.3.2

# 2. 依存関係インストール
pip install -r requirements.txt

# 3. 開発サーバー起動
python -m src.attendance_app.main  # デスクトップアプリ
python web_app/app.py              # Webアプリ
```

### 2. ビルドプロセス
```bash
# 1. 依存関係確認
pip list | findstr "kivy flask openpyxl"

# 2. 実行ファイル作成
pyinstaller attendance_app.spec --clean

# 3. 動作確認
cd dist/AttendanceManagementSystem
./AttendanceManagementSystem.exe
```

### 3. 配布プロセス
1. **テスト実行**: `配布チェックリスト.md`に従って確認
2. **パッケージ作成**: `dist/AttendanceManagementSystem/`をZIP圧縮
3. **ドキュメント同梱**: `配布用README.md`を含める

## 🐛 既知の問題と対応

### 1. 相対インポートエラー
**問題**: PyInstallerで実行時に相対インポートが失敗
**対応**: try-except文で絶対インポートにフォールバック

### 2. 画像パスの問題
**問題**: 実行ファイルで画像が見つからない
**対応**: `get_base_dir()`関数でパス解決

### 3. Webアプリケーション起動
**問題**: ブラウザが自動起動しない
**対応**: `webbrowser.open()`の例外処理追加

### 4. Excel生成エラー
**問題**: テンプレートファイルが見つからない
**対応**: PyInstallerの`datas`設定でアセット包含

## 📊 パフォーマンス指標

### 実行ファイル
- **サイズ**: 約180MB（圧縮前）
- **起動時間**: 約10-15秒
- **メモリ使用量**: 約300-400MB

### レポート生成
- **PDF生成**: 約2-3秒/生徒
- **Excel生成**: 約3-5秒/生徒
- **プレビュー**: 約1-2秒

## 🔐 セキュリティ考慮事項

### 機密情報管理
- `service_account.json`: Google API認証（配布時除外）
- `settings.json`: アプリケーション設定（配布時除外）
- 個人情報: Google Sheets上で管理

### 実行権限
- 標準ユーザー権限で実行可能
- 管理者権限不要
- Windows Defender対応

## 🔄 今後の拡張計画

### 短期的改善
1. **エラーハンドリング強化**
2. **ログ機能追加**
3. **設定UI改善**
4. **多言語対応**

### 中期的機能追加
1. **データベース統合**
2. **クラウドストレージ対応**
3. **モバイルアプリ版**
4. **統計分析機能**

### 長期的展望
1. **マルチテナント対応**
2. **AI機能統合**
3. **API公開**
4. **プラグインシステム**

## 📞 サポート体制

### 開発者連絡先
- **技術的質問**: 開発チームまでご連絡ください
- **バグレポート**: GitHub Issues をご利用ください
- **機能要望**: 製品チームまでご連絡ください

### ドキュメント
- **ユーザーマニュアル**: `配布用README.md`
- **開発者ガイド**: `README.md`
- **API仕様**: `web_app/app.py`内コメント

## 🎯 重要なコード箇所

### 1. Excel生成のコア処理
```python
# src/attendance_app/report_system/excel_report_generator.py:300-335
def create_student_sheet(self, student_id: str, year: int, month: int) -> str:
    """生徒個人のシートを作成"""
    # 出席データを取得
    attendance_data = get_monthly_attendance_data(student_id, year, month)
    # ワークシート作成とレイアウト設定
    # テンプレート準拠の書式設定
    # プルダウンリスト追加
```

### 2. Web連携処理
```python
# src/attendance_app/report_screen.py:562-569
def open_report_editor(self, instance):
    """レポートエディタをブラウザで開く"""
    try:
        editor_url = "http://localhost:5000"
        webbrowser.open(editor_url)
    except Exception as e:
        self.show_popup("エラー", f"ブラウザでレポートエディタを開けませんでした: {e}")
```

### 3. 画像処理
```python
# src/attendance_app/report_system/excel_report_generator.py:103-127
def add_logo(self, worksheet):
    """ロゴ画像を配置（縦横比固定、高さ62%）"""
    # 元画像サイズ取得
    # 縦横比維持でリサイズ
    # Excel シートに配置
```

## 📝 変更履歴

### v3.2.0 (2025-07-18)
- ✅ Excel レポート生成機能追加
- ✅ テンプレート準拠レイアウト実装
- ✅ プルダウンリスト機能追加
- ✅ デスクトップ-Web連携機能
- ✅ 実行可能ファイル化
- ✅ 配布パッケージ作成

### v3.0.0 (2025-07-17)
- ✅ Flask Webアプリケーション統合
- ✅ リアルタイムプレビュー機能
- ✅ 画像管理システム
- ✅ PDF生成エンジン改善

---

**引継ぎ完了日**: 2025年7月18日
**作成者**: Claude Code Assistant
**最終更新**: 2025年7月18日

**注意**: この資料は技術的な詳細を含むため、開発者向けです。エンドユーザーには`配布用README.md`をご参照ください。